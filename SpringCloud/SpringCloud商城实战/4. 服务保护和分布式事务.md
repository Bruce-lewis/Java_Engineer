![[Pasted image 20250107091751.png]]
# 4.1 服务保护
## 4.1.1 雪崩问题

说一下
>[!info]-
>微服务调用链路中某个服务故障，进而引起整个链路中的所有微服务都不可用，这就是服务雪崩。


![[Pasted image 20250107092016.png]]
雪崩问题产生的原因是什么？
>[!info]-
>step1 微服务相互调用，服务提供者出现故障或者阻塞。
>step2 服务调用者没有做好异常处理，导致自身故障。
>step3 调用链路中所有服务级联失败，导致整个集群故障。

![[Pasted image 20250107092306.png]]
## 4.1.2 请求限流
解决：流量激增访问

什么是请求限流？
>[!info]-
>限制访问微服务的请求的并发量，避免服务因流量激增出现故障。

![[Pasted image 20250107092544.png]]
## 4.1.3 舱壁隔离（资源隔离）
解决：限制异常扩散

舱壁隔离：
>[!info]-
>我理解是 资源隔离，模拟船舱隔板的防水原理。 通过限定每个业务能使用的线程数量而将故障业务隔离，避免故障扩散。

![[Pasted image 20250107092910.png]]
## 4.1.4 服务熔断
解决：在下游系统出故障时，提高相应速度。

>[!info]-
>由==断路器==统计请求的异常调用比例或者慢调用比例，如果超出阈值则会熔断该业务，拦截该接口的所有请求。熔断期间，全都走fallback逻辑; 当服务恢复时，断路器会放行访问该接口的请求。

![[Pasted image 20250107093620.png]]
![[Pasted image 20250107094138.png]]
![[Pasted image 20250107094441.png]]

# 4.2 Sentinel

## 4.2.1 初识Sentinel

是什么？
>[!info]-
>Sentinel 是alibaba 提供的一款微服务流量控制组件。官网地址：https://sentinelguard.io/zh-cn/index.html

![[Pasted image 20250107100404.png]]
![[Pasted image 20250107100422.png]]
![[Pasted image 20250107100537.png]]
## 4.2.2 请求限流
![[Pasted image 20250107102627.png]]
![[Pasted image 20250107104957.png]]
## 4.2.3 舱壁隔离
资源隔离，线程隔离
![[Pasted image 20250107105120.png]]
## 4.2.4 Fallback
默认Sentinel会监控Spring MVC的EndPoint （Http接口），所以我们要将FeignClient也设置为Sentinel的簇点链路资源
![[Pasted image 20250107110258.png]]
![[Pasted image 20250107110316.png]]
![[Pasted image 20250107110406.png]]
![[Pasted image 20250107110439.png]]
## 4.2.5 服务熔断
完全断开 访问
![[Pasted image 20250107125420.png]]
![[Pasted image 20250107125719.png]]
![[Pasted image 20250107125726.png]]

# 4.3 分布式事务
![[Pasted image 20250107130551.png]]

什么是分布式事务？

>[!info]-
>在分布式系统中，如果一个业务需要多个服务合作完成，而且每一个服务都有事务，多个事务必须同时成功或者失败，这样的事务就是==分布式事务==。其中每一个服务的事务就是一个==分支事务==。 整个业务称为==全局事务==。 



## 4.3.1 初始Seata
Seata是什么？
>[!info]-
>Seata是一款开源的分布式事务解决方案，致力于在微服务架构下提供高性能和简单易用的分布式事务服务。


![[Pasted image 20250107131110.png]]
![[Pasted image 20250107131349.png]]

Seata事务管理中的三个重要角色
>[!info]-
>TC: Transaction Coordinator 事务协调者：可以理解为Seata本身，维护全局和分支事务的状态，协调全局事务提交或回滚。
>TM: Transaction Manager 事务管理器： 定义全局事务的范围，开始一个全局事务、提交或者回滚全局事务。
>RM：Resource Manager 资源管理器：管理分支事务，与TC通信以注册分支事务和报告分支事务的状态。


![[Pasted image 20250107131733.png]]
## 4.3.2 部署TC服务
![[Pasted image 20250107131831.png]]
## 4.3.3 微服务集成Seata
![[Pasted image 20250107135256.png]]
![[Pasted image 20250107135234.png]]
## 4.3.4 XA模式

XA模式
>[!info]-
>一阶段的工作：
>①RM注册分支事务到TC
>②RM执行分支业务sql但不提交
>③RM报告分支事务的执行状态到TC
>二阶段的工作：
>TC检测各个分支事务执行状态
>	a. 如果都成功，通知所有RM提交事务。
>	b. 如果有失败，通过所有RM回滚事务。
>RM接受TC指定，提交或者回滚事务。


![[Pasted image 20250107140108.png]]

说一下XA模式的优缺点
>[!info]-
>优点：
>事务的强一致性，满足ACID原则。
>缺点：
>一阶段需要锁定数据库资源，等待二阶段结束才释放，性能较差。


![[Pasted image 20250107140131.png]]
![[Pasted image 20250107140158.png]]
## 4.3.5 AT模式
说一下AT模式
>[!info]-
>阶段一RM的工作：
>①RM注册分支事务到TC
>②记录数据快照到undo-log表
>③执行分支事务sql并提交
>④RM报告分支事务状态到TC
>阶段二提交时RM的工作
>成功时 删除undo-log表中的数据
>失败时 根据undo-log表恢复数据到更新前。

![[Pasted image 20250107140820.png]]


简述AT模式和XA模式最大的区别是什么？
>[!info]-
>XA模式一阶段不提交事务，锁定资源，AT模式直接提交，不锁定资源。
>XA模式依赖数据库机制实现回滚。AT模式利用数据快照实现数据回滚。
>XA模式强一致性，AT模式最终一致性。

![[Pasted image 20250107141014.png]]

![[Pasted image 20250107141137.png]]
